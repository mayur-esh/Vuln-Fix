@ECHO off
:: Microsoft Windows SMBv3 Remote Code Execution Vulnerability (CVE-2020-0796)
:: https://blog.qualys.com/vulnerabilities-threat-research/2020/03/11/microsoft-windows-smbv3-remote-code-execution-vulnerability-cve-2020-0796
:: https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-0796

:: This script will disable SMBv3 Compression
%SystemRoot%\system32\reg.exe query "HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" 2>nul | %SystemRoot%\system32\findstr.exe /I "DisableCompression " | %SystemRoot%\system32\findstr.exe /I "0x1" >nul

IF %ERRORLEVEL% == 0 (
	ECHO OK - Reg key exists
	EXIT /b 0
) ELSE (
    GOTO SETVAR
)

:SETVAR
%SystemRoot%\system32\reg.exe add "HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" /v DisableCompression /t REG_DWORD /d 1 /f 2>nul

%SystemRoot%\system32\reg.exe query "HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" 2>nul | %SystemRoot%\system32\findstr.exe /I "DisableCompression " | %SystemRoot%\system32\findstr.exe /I "0x1" >nul

IF %ERRORLEVEL% == 0 (
	ECHO OK - Reg key set
	EXIT /b 0
) ELSE (
    ECHO ERR - Can not set reg key
    EXIT /b 1
)
